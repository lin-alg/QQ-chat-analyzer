<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>QQèŠå¤©è®°å½•æ·±åº¦åˆ†æå™¨ v2.0</title>

    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
        --primary: #3b82f6;
        --primary-dark: #2563eb;
        --primary-light: #93c5fd;
        --bg: #f9fbfc;
        --surface: #ffffff;
        --text-main: #1f2937;
        --text-sub: #6b7280;
        --border: #e5e7eb;
        --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--bg);
        color: var(--text-main);
        margin: 0;
        padding: 30px 20px;
        line-height: 1.6;
        font-weight: 400;
    }

    .container {
        max-width: 1300px;
        margin: 0 auto;
    }

    header {
        text-align: center;
        margin-bottom: 40px;
        padding: 50px 0;
        background: linear-gradient(135deg, var(--primary-dark) 0%, #8b5cf6 100%); 
        border-radius: 24px;
        color: white;
        box-shadow: var(--shadow);
    }
    header h1 { 
        margin: 0; 
        font-size: 2.8rem;
        letter-spacing: -1.5px; 
        font-weight: 800;
    }
    header p { 
        opacity: 0.9; 
        margin-top: 10px; 
        font-size: 1.2rem; 
        font-weight: 300;
    }

    .controls {
        background: var(--surface);
        padding: 30px;
        border-radius: 18px;
        box-shadow: var(--shadow);
        margin-bottom: 30px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        border: 1px solid var(--border);
    }

    .file-upload-wrapper {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }

    input[type="file"] {
        color: var(--text-sub);
        padding: 10px 0;
    }

    textarea {
        width: 100%;
        height: 120px;
        padding: 15px;
        border: 1px solid var(--border);
        border-radius: 12px;
        resize: vertical;
        font-family: monospace;
        box-sizing: border-box;
        transition: all 0.3s ease;
        background: var(--bg);
    }
    textarea:focus { 
        outline: none; 
        border-color: var(--primary); 
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        background: var(--surface);
    }

    button {
        background-color: var(--primary);
        color: white;
        padding: 12px 35px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1.05rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(59, 130, 246, 0.25);
    }
    button:hover { 
        background-color: var(--primary-dark); 
        transform: translateY(-2px); 
        box-shadow: 0 6px 12px rgba(59, 130, 246, 0.4);
    }

    .dashboard {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 30px;
        display: none;
    }

    .card {
        background: var(--surface);
        padding: 30px;
        border-radius: 20px; 
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        overflow: hidden;
        transition: transform 0.2s;
    }

    .col-4 { grid-column: span 4; }
    .col-6 { grid-column: span 6; }
    .col-8 { grid-column: span 8; }
    .col-12 { grid-column: span 12; }

    @media (max-width: 1024px) {
        .col-4, .col-6, .col-8 { grid-column: span 12; }
    }

    h2 {
        color: var(--text-main);
        font-size: 1.35rem;
        font-weight: 700;
        margin-top: 0;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 20px;
    }
    .stat-box {
        background: var(--bg);
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        border: 1px solid var(--border);
        transition: all 0.2s;
    }
    .stat-box:hover {
        background: var(--primary-light);
        color: var(--text-main);
    }
    .stat-num { 
        display: block; 
        font-size: 2.2rem;
        font-weight: 800; 
        color: var(--primary-dark);
    }
    .stat-label { 
        font-size: 0.95rem; 
        color: var(--text-sub); 
        margin-top: 8px; 
        font-weight: 500;
    }

    .table-wrap {
        max-height: 500px;
        overflow-y: auto;
        border-radius: 10px;
        border: 1px solid var(--border);
    }
    table { width: 100%; border-collapse: collapse; }
    th { 
        text-align: left; 
        padding: 15px;
        background: var(--bg); 
        color: var(--text-sub);
        position: sticky;
        top: 0;
        font-weight: 600;
        font-size: 0.95rem;
    }
    td { 
        padding: 15px; 
        border-bottom: 1px solid var(--border); 
        font-size: 0.95rem;
    }
    tr:nth-child(even) {
        background-color: #fcfdfe;
    }
    tr:last-child td { border-bottom: none; }

    .rank-num { 
        display: inline-block; 
        width: 28px; 
        height: 28px; 
        line-height: 28px; 
        text-align: center; 
        border-radius: 50%; 
        background: var(--primary-light); 
        color: var(--primary-dark); 
        font-size: 0.9rem; 
        font-weight: bold; 
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    tr:nth-child(1) .rank-num { background: #fecaca; color: #dc2626; }
    tr:nth-child(2) .rank-num { background: #fde68a; color: #d97706; }
    tr:nth-child(3) .rank-num { background: #bfdbfe; color: #1d4ed8; }

    .emoji-display {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px; 
        font-size: 28px; 
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg);
    }
    .emoji-img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: transform 0.2s;
    }
    .emoji-img:hover { transform: scale(1.2); }

    .cloud-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        padding: 20px;
        min-height: 150px;
    }
    .tag {
        background: var(--bg);
        padding: 6px 14px;
        border-radius: 25px;
        color: var(--text-main);
        font-size: 1rem;
        transition: all 0.3s ease;
        cursor: default;
        border: 1px solid var(--border);
    }
    .tag:hover {
        background: var(--primary);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .loading-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(3px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        font-size: 1.8rem;
        color: var(--primary-dark);
        font-weight: bold;
        letter-spacing: 1px;
        display: none;
    }
            
    .exclusion-setup {
        border-top: 1px solid var(--border);
        padding-top: 20px;
        margin-top: 10px;
    }
    .exclusion-input-wrapper {
        margin-top: 10px;
    }
    .qq-input {
        width: 100%;
        height: 90px;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 10px;
        resize: vertical;
        font-family: monospace;
        box-sizing: border-box;
        font-size: 0.9rem;
        background: var(--bg);
    }
    .qq-input:focus {
        outline: none; 
        border-color: var(--primary); 
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    .speaker-info {
        display:flex; 
        align-items:center;
    }

    .speaker-avatar {
        width:40px; 
        height:40px; 
        border-radius:50%; 
        margin-right:12px; 
        object-fit: cover;
        border: 2px solid var(--border);
    }

    .speaker-name {
        font-weight:700;
        font-size: 1rem;
        color: var(--text-main);
    }

    .speaker-uin {
        font-size:12px; 
        color:var(--text-sub);
    }
        
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">ğŸ“Š æ­£åœ¨å…¨é€Ÿåˆ†æä¸­...</div>

    <div class="container">
        <header>
            <h1>QQèŠå¤©è®°å½•æ·±åº¦åˆ†æå™¨ v2.0</h1>
            <div class="notice">
                æœ¬å·¥å…·ç”¨äºåˆ†æä» QQ å¯¼å‡ºçš„JSONæ ¼å¼èŠå¤©è®°å½•ã€‚æœ¬ç½‘é¡µåœ¨æµè§ˆå™¨ç¦»çº¿ç¯å¢ƒä¸­è¿è¡Œï¼Œä¸ä¼šä¸Šä¼ ä»»ä½•æ•°æ®ï¼Œè¯·æ‚¨æ”¾å¿ƒä½¿ç”¨ã€‚<br>
                èŠå¤©è®°å½•å¯¼å‡ºå·¥å…·ï¼š
                <a href="https://github.com/shuakami/qq-chat-exporter" target="_blank">
                shuakami/qq-chat-exporter
                </a>
            </div>
        </header>
        

        <div class="controls">
            <div class="file-upload-wrapper">
                <input type="file" id="fileInput" accept=".json" style="flex: 1;">
                <button onclick="startAnalysis()">ğŸš€ å¼€å§‹åˆ†æ</button>
            </div>
            <textarea id="jsonInput" placeholder="æˆ–è€…ç›´æ¥å°† JSON å†…å®¹ç²˜è´´åˆ°è¿™é‡Œ..."></textarea>
            
            <div class="exclusion-setup">
            <label>
                <input type="checkbox" id="excludeCheckbox" onchange="toggleExclusionInput()">
                æ’é™¤æŒ‡å®šæˆå‘˜ (å¦‚QQæœºå™¨äºº)
            </label>
            <div id="exclusionInputWrapper" class="exclusion-input-wrapper" style="display: none;">
                <p style="font-size: 0.9rem; color: var(--text-sub); margin: 5px 0;">è¯·æŒ‰è¡Œè¾“å…¥è¦æ’é™¤çš„æˆå‘˜ QQ å·ï¼š</p>
                <textarea id="excludedQQList" class="qq-input" placeholder="ä¾‹å¦‚ï¼š
10001
10002
2854196310(Qç¾¤ç®¡å®¶)
        "></textarea>
            </div>

            <!-- æ–°å¢å¤é€‰æ¡† -->
            <label style="margin-top:10px; display:block;">
                <input type="checkbox" id="dedupCheckbox">
                ä¸å—åˆ·å±ç‹—çš„å½±å“ï¼ˆå»é‡ç»Ÿè®¡ï¼‰
            </label>
        </div>
            
        </div>

        <div id="results" class="dashboard">
            
            <div class="card col-12" id="overviewCard">
                </div>
            
            <div class="card col-12">
                <h2>â° æ´»è·ƒæ—¶æ®µç»Ÿè®¡ (24å°æ—¶åˆ¶)</h2>
                <div style="height: 300px;">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <div class="card col-4">
                <h2>ğŸ˜œ è¡¨æƒ…åŒ… Top 50</h2>
                <div class="table-wrap">
                    <table id="emojiTable">
                        <thead>
                            <tr>
                                <th width="60">æ’å</th>
                                <th>è¡¨æƒ…</th>
                                <th>æ¬¡æ•°</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card col-8">
                <h2>ğŸ† é¾™ç‹æ’è¡Œæ¦œ</h2>
                <div class="table-wrap">
                    <table id="speakerTable">
                        <thead>
                            <tr>
                                <th width="60">æ’å</th>
                                <th>ç”¨æˆ·</th>
                                <th>æ¶ˆæ¯æ•°</th>
                                <th>æ´»è·ƒåº¦</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card col-6">
                <h2>ä¸­æ–‡èŠå¤©çƒ­è¯ (æ™ºèƒ½è¿‡æ»¤)</h2>
                <div class="cloud-container" id="chineseWordCloud"></div>
            </div>
            
            <div class="card col-6">
                <h2>è‹±æ–‡/ä»£ç çƒ­è¯ (æ™ºèƒ½è¿‡æ»¤)</h2>
                <div class="cloud-container" id="englishWordCloud"></div>
            </div>
            </div>
    </div>

    <script>
        // === é…ç½®é¡¹ ===
        
        // è¿‡æ»¤æ‰æ— æ„ä¹‰çš„é«˜é¢‘è¯
        const STOP_WORDS = new Set([
            // === ç°æœ‰ä¸­æ–‡åœç”¨è¯  ===
            "çš„", "äº†", "åœ¨", "æ˜¯", "æˆ‘", "æœ‰", "å’Œ", "å°±", "ä¸", "äºº", "éƒ½", "ä¸€", "ä¸€ä¸ª", "ä¸Š", "ä¹Ÿ", "å¾ˆ", "åˆ°", "è¯´", "è¦", "å»", "ä½ ", "ä¼š", "ç€", "æ²¡æœ‰", "çœ‹", "å¥½", "è‡ªå·±", "è¿™", "é‚£", "æœ‰", "ä¸ª", "ä¹‹", "ä¸º", "å¯¹", "èƒ½", "è¢«", "è®©", "å®ƒ", "ä¸", "åŠ", "ç­‰", "æˆ–", 
            
            // === èŠå¤©ã€ç³»ç»Ÿç›¸å…³è¯  ===
            "å›¾ç‰‡", "è¡¨æƒ…", "å›å¤", "æ¶ˆæ¯", "æ’¤å›", "ç³»ç»Ÿ", "æç¤º", "åŠ å…¥", "é€€å‡º", "é‚€è¯·", "ç¾¤èŠ", "ç¾¤èŠçš„èŠå¤©è®°å½•","èŠå¤©è®°å½•","åˆå¹¶è½¬å‘","æŸ¥çœ‹","æ¡è½¬å‘æ¶ˆæ¯","ç”¨æˆ·","æ–‡ä»¶","å¡ç‰‡æ¶ˆæ¯","è§†é¢‘","å°ç¨‹åº","åŠ¨ç”»è¡¨æƒ…","çš„èŠå¤©è®°å½•","æ¸¸æˆåç§°","æš‚ä¸æ”¯æŒè¯¥æ¶ˆæ¯ç±»å‹","è¯·ç”¨æ‰‹æœº",

            
            // === é€šç”¨é“¾æ¥/æ–‡ä»¶åç¼€ ===
            "http", "https", "com", "www", "net", "org",  
            
            // ====================================================
            // === è‹±æ–‡é«˜é¢‘æ™®é€šè¯ ===
            "the", "and", "but", "for", "are", "you", "that", "this", "what", "with", "from", "have", "they", "just", "like", "know", "when", "don", "can", "get", "out", "only", "need", "about", "your", "all", "its", "too", "will", "would", "should", "could", "here", "there", "them", "which", "then", "into", "some", "more", "much", "time", "day", "was", "has", "had", "been", "make", "take", "look", "back", "thing", "even", "than", "well",
            
            // === å¸¸è§ç¼–ç¨‹/æŠ€æœ¯è¯æ±‡  ===
            "code", "data", "test", "class", "function", "const", "var", "let", "return", "import", "export", "async", "await", "error", "null", "undefined", "true", "false", "system", "server", "client", "request", "response", "project", "stack", "overflow", "version", "update", "patch", "pull", "push", "main", "branch", "master", "commit", "config", "setup", "build", "script", "module", "string", "number", "array", "object", "value", "local", "remote", "status", "debug", "release",
            
            // === å¸¸è§æ–‡ä»¶/æŠ€æœ¯åç¼€ (æ‰©å……) ===
            "json", "html", "css", "js", "java", "py", "sh", "cpp", "exe", "apk", "zip", "rar", "tar", "gz", "ini", "log", "yaml", "xml", "md", "txt", "pdf", "vue", "react", "node", "npm", "yarn", "docker", "k8s", "linux", "macos", "window",

            // === QQæ¶ˆæ¯ç»“æ„ä½“ç›¸å…³å­—æ®µ ===
            "title", "color", "size", "msg", "item", "summary", "source", "flag", "name", "action", "encoding", "utf", "standalone", "yes", "serviceid", "templateid", "viewmultimsg", "brief", "filename", "resid", "tsum", "layout",  "mqqapi", "enter", "inlinecmd", "command", "reply", "text", "markdown", "mention"

        ]);
        
        // ç”¨äºå­˜å‚¨ Chart.js å®ä¾‹
        let activityChartInstance = null;
        
        // ç”¨äºå­˜å‚¨ UIN å¯¹åº”çš„ä¿¡æ¯ï¼Œåœ¨ processData ä¸­åˆå§‹åŒ–
        let senderInfoMap = new Map(); 

        // --- æ–°å¢å‡½æ•°ï¼šåˆ‡æ¢æ’é™¤QQå·è¾“å…¥æ¡†çš„æ˜¾ç¤º ---
        function toggleExclusionInput() {
            const checkbox = document.getElementById('excludeCheckbox');
            const wrapper = document.getElementById('exclusionInputWrapper');
            wrapper.style.display = checkbox.checked ? 'block' : 'none';
        }

        // --- æ–°å¢å‡½æ•°ï¼šè·å–è¦æ’é™¤çš„ QQ å·é›†åˆ ---
        function getExcludedQQSet() {
            const checkbox = document.getElementById('excludeCheckbox');
            if (!checkbox.checked) {
                return new Set();
            }
            
            const input = document.getElementById('excludedQQList').value;
            // æŒ‰è¡Œåˆ†å‰²ï¼Œè¿‡æ»¤æ‰ç©ºè¡Œï¼Œå¹¶è½¬ä¸º Set æ–¹ä¾¿æŸ¥æ‰¾
            const qqArray = input.split('\n')
                                 .map(qq => qq.trim())
                                 .filter(qq => qq.length > 0 && /^\d+$/.test(qq)); // ç¡®ä¿æ˜¯æ•°å­—
            return new Set(qqArray);
        }
        
        function getDedupFlag() {
            return document.getElementById('dedupCheckbox').checked;
        }

        function startAnalysis() {
            const fileInput = document.getElementById('fileInput');
            const jsonInput = document.getElementById('jsonInput').value.trim();
            const loading = document.getElementById('loading');
            
            loading.style.display = 'flex';

            // å»¶æ—¶æ‰§è¡Œä»¥å…è®¸ UI æ¸²æŸ“ Loading
            setTimeout(() => {
                if (fileInput.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            processData(event.target.result);
                        } catch(e) {
                            alert("æ–‡ä»¶è§£æå¤±è´¥ï¼š" + e.message);
                        } finally {
                            loading.style.display = 'none';
                        }
                    };
                    reader.readAsText(fileInput.files[0]);
                } else if (jsonInput) {
                    try {
                        processData(jsonInput);
                    } catch(e) {
                        alert("JSON æ ¼å¼é”™è¯¯");
                    } finally {
                        loading.style.display = 'none';
                    }
                } else {
                    alert('è¯·ä¸Šä¼ æ–‡ä»¶æˆ–ç²˜è´´å†…å®¹');
                    loading.style.display = 'none';
                }
            }, 100);
        }
        
        // æ–°å¢å‡½æ•°ï¼šæ‰«ææ¶ˆæ¯è®°å½•ï¼Œå»ºç«‹ uin -> senderInfo æ˜ å°„
        function extractSenderInfo(messages) {
            const infoMap = new Map();
            messages.forEach(msg => {
                const sender = msg.sender;
                if (sender && sender.uin) {
                    const uin = String(sender.uin);
                    // ä»…åœ¨ name ä¸ä¸ºç©ºæ—¶æ›´æ–°ï¼Œé¿å…è¢«åé¢ name ä¸ºç©ºçš„è®°å½•è¦†ç›–
                    if (sender.name && sender.name !== '') {
                        infoMap.set(sender.name, {
                            name: sender.name,
                            uin: uin,
                            uid: sender.uid || null
                        });
                    } else if (!infoMap.has(uin)) {
                         // å¦‚æœ map ä¸­è¿˜æ²¡æœ‰è®°å½•ï¼Œåˆ™å…ˆç”¨ uin/uid å ä½
                         infoMap.set(sender.name, {
                            name: uin, // é»˜è®¤ä½¿ç”¨ uin ä½œä¸ºåå­—
                            uin: uin,
                            uid: sender.uid || null
                        });
                    }
                }
            });
            return infoMap;
        }


        function processData(jsonString) {
            const data = JSON.parse(jsonString);
            document.getElementById('results').style.display = 'grid';

            // 1. æå–å¹¶å­˜å‚¨å‘ä¿¡äººä¿¡æ¯æ˜ å°„è¡¨ (å“ˆå¸Œè¡¨)
            senderInfoMap = extractSenderInfo(data.messages);

            // 2. åŸºç¡€æ¦‚è§ˆ
            renderOverview(data);

            // 3. å‘è¨€æ’è¡Œ (ä¼ å…¥æ˜ å°„è¡¨)
            renderSpeakers(data.statistics.senders, senderInfoMap);

            // 4. å†…å®¹æ·±åº¦åˆ†æ (æ–‡æœ¬ + è¡¨æƒ…)
            const excludedQQs = getExcludedQQSet();
            const analysis = analyzeContent(data.messages, excludedQQs);
            
            // 5. æ¸²æŸ“è¡¨æƒ…æ’è¡Œ
            renderEmojis(analysis.emojiCounts);

            // 6. æ¸²æŸ“çƒ­è¯ (åˆ†åˆ«æ¸²æŸ“ä¸­æ–‡å’Œè‹±æ–‡)
            renderHotWords(analysis.chineseWordCounts, 'chineseWordCloud');
            renderHotWords(analysis.englishWordCounts, 'englishWordCloud');
            
            // 7. æ´»è·ƒæ—¶æ®µåˆ†æ
            const activityData = analyzeActivity(data.messages);
            renderActivityChart(activityData);
        }

        function renderOverview(data) {
        const card = document.getElementById('overviewCard');
        const startDate = new Date(data.statistics.timeRange.start).toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'numeric',
            day: 'numeric'
        });
        const endDate = new Date(data.statistics.timeRange.end).toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'numeric',
            day: 'numeric'
        });
        
        // è·å–æ€»æ¶ˆæ¯æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤º 0
        const totalMsg = data.statistics.totalMessages || 0;

        card.innerHTML = `
            <h2>ğŸ“Š èŠå¤©æ¦‚è§ˆ - ${data.chatInfo.name || 'æœªå‘½åç¾¤èŠ'}</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <span class="stat-num">${totalMsg.toLocaleString()}</span>
                    <span class="stat-label">æ¶ˆæ¯æ€»é‡</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" style="font-size:1.2rem; line-height:2.2rem">${startDate}</span>
                    <span class="stat-label">å¼€å§‹æ—¶é—´</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" style="font-size:1.2rem; line-height:2.2rem">${endDate}</span>
                    <span class="stat-label">ç»“æŸæ—¶é—´</span>
                </div>
            </div>
        `;
    }
        
        // === æ ¸å¿ƒä¿®æ”¹ï¼šæ¥æ”¶ excludedQQs å‚æ•°å¹¶åœ¨çƒ­è¯ç»Ÿè®¡æ—¶è·³è¿‡ï¼Œå¹¶æ›´æ–°è‹±æ–‡æ­£åˆ™åŒ¹é…é€»è¾‘ ===
        function analyzeContent(messages, excludedQQs) {
            const chineseWordCounts = {};
            const englishWordCounts = {};
            const emojiCounts = {};
            const deduplicate = getDedupFlag();
            const unicodeEmojiRegex = /(\p{RI}\p{RI}|\p{Emoji_Presentation}|\p{Extended_Pictographic})/gu;
            // åŒ¹é…ä¸­æ–‡(2å­—ä»¥ä¸Š)
            const chineseRegex = /[\u4e00-\u9fa5]{2,}/g; 
            // åŒ¹é…å®Œæ•´çš„è‹±æ–‡å•è¯ (è‡³å°‘4ä¸ªå­—æ¯)ï¼Œä½¿ç”¨ \b å•è¯è¾¹ç•Œ
            const englishRegex = /\b[a-zA-Z]{4,}\b/g;

            messages.forEach(msg => {
                // æ’é™¤é€»è¾‘ï¼šå¦‚æœæ¶ˆæ¯å‘é€è€… (sender.uin) åœ¨ excludedQQs é›†åˆä¸­ï¼Œåˆ™è·³è¿‡çƒ­è¯ç»Ÿè®¡ã€‚
                // *æ³¨æ„ï¼šè¡¨æƒ…åŒ…ç»Ÿè®¡ä»ä¿ç•™ï¼Œå› ä¸ºç”¨æˆ·æ²¡æœ‰æ˜ç¡®è¦æ±‚æ’é™¤*
                const senderUin = msg.sender && msg.sender.uin ? String(msg.sender.uin) : null;
                const shouldExcludeForWords = senderUin && excludedQQs.has(senderUin);
                
                if (!msg.content) return;

                if (msg.content.text) {
                    let text = msg.content.text;
                    // 1. æ¸…ç†æ–‡æœ¬ç”¨äºåˆ†è¯
                    text = text.replace(/\[å›å¤.*?\]/g, '') 
                               .replace(/@[\w\u4e00-\u9fa5]+/g, '') 
                               .replace(/https?:\/\/\S+/g, '');

                    // === æ’é™¤å¼€å§‹ ===
                    if (!shouldExcludeForWords) {
                    // æ¯æ¡æ¶ˆæ¯å†…çš„å»é‡é›†åˆ
                    const seenEmoji = new Set();
                    const seenCn = new Set();
                    const seenEn = new Set();
                    const seenQQEmoji = new Set();

                    // 2. æå– Unicode è¡¨æƒ… 
                    const uMatches = text.match(unicodeEmojiRegex);
                    if (uMatches) {
                        uMatches.forEach(emoji => {
                            if (emoji.trim().length > 0) {
                                if (deduplicate && seenEmoji.has(emoji)) return;
                                seenEmoji.add(emoji);
                                emojiCounts[emoji] = (emojiCounts[emoji] || 0) + 1;
                            }
                        });
                    }

                    // 3. ä¸­æ–‡çƒ­è¯
                    const chineseWords = text.match(chineseRegex) || [];
                    chineseWords.forEach(word => {
                        if (STOP_WORDS.has(word)) return;
                        if (deduplicate && seenCn.has(word)) return;
                        seenCn.add(word);
                        chineseWordCounts[word] = (chineseWordCounts[word] || 0) + 1;
                    });

                    // 4. è‹±æ–‡çƒ­è¯
                    const englishWords = text.match(englishRegex) || [];
                    englishWords.forEach(word => {
                        const lowerCaseWord = word.toLowerCase();
                        if (STOP_WORDS.has(lowerCaseWord)) return;
                        if (/^[\d\W]+$/.test(lowerCaseWord)) return;
                        if (deduplicate && seenEn.has(lowerCaseWord)) return;
                        seenEn.add(lowerCaseWord);
                        englishWordCounts[lowerCaseWord] = (englishWordCounts[lowerCaseWord] || 0) + 1;
                    });

                    // 5. QQ ä¸“æœ‰è¡¨æƒ…
                    if (msg.content.emojis && Array.isArray(msg.content.emojis)) {
                        msg.content.emojis.forEach(e => {
                            const key = /^\d+$/.test(e.id) ? e.id : e.name;
                            if (deduplicate && seenQQEmoji.has(key)) return;
                            seenQQEmoji.add(key);
                            emojiCounts[key] = (emojiCounts[key] || 0) + 1;
                        });
                    }
                    }
                }
            });

            return { chineseWordCounts, englishWordCounts, emojiCounts };
        }
        
        // --- æ´»è·ƒæ—¶æ®µåˆ†æå‡½æ•° ---
        function analyzeActivity(messages) {
            const hourCounts = Array(24).fill(0); // 0ç‚¹åˆ°23ç‚¹
            
            messages.forEach(msg => {
                const timeString = msg.time || msg.timestamp; 
                if (timeString) {
                    const date = new Date(timeString);
                    
                    if (!isNaN(date)) { 
                        // å°† UTC æ—¶é—´è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
                        const hour = (date.getUTCHours() + 8) % 24; 

                        if (hour >= 0 && hour < 24) {
                            hourCounts[hour]++;
                        }
                    }
                }
            });
            
            return hourCounts;
        }

        // --- æ¸²æŸ“æ´»è·ƒæ—¶æ®µå›¾è¡¨å‡½æ•° ---
        function renderActivityChart(hourCounts) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            if (activityChartInstance) {
                activityChartInstance.destroy();
            }

            const labels = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`); 
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
            const primaryLightColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-light').trim();

            activityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ¶ˆæ¯æ•°',
                        data: hourCounts,
                        backgroundColor: primaryColor,
                        borderColor: primaryColor,
                        borderWidth: 1,
                        borderRadius: 5,
                        hoverBackgroundColor: primaryLightColor,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: (items) => `æ—¶é—´: ${items[0].label}`,
                                label: (context) => `æ¶ˆæ¯æ•°: ${context.formattedValue}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'æ¶ˆæ¯æ€»æ•°'
                            },
                            ticks: { precision: 0 }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å°æ—¶ (24å°æ—¶åˆ¶)'
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }


        function renderEmojis(emojiCounts) {
            const tbody = document.getElementById('emojiTable').querySelector('tbody');
            tbody.innerHTML = '';

            const sorted = Object.entries(emojiCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50);

            sorted.forEach(([key, count], index) => {
                const tr = document.createElement('tr');
                
                const isNumberId = /^\d+$/.test(key);
                
                let displayHtml = '';
                const unicodeEmojiRegex = /(\p{RI}\p{RI}|\p{Emoji_Presentation}|\p{Extended_Pictographic})/u;

                if (isNumberId) {
                    const imgPath = `./emojis/${key}/png/${key}.png`;
                    displayHtml = `
                        <div class="emoji-display">
                            <img src="${imgPath}" class="emoji-img" title="ID: ${key}" 
                                onerror="this.onerror=null; this.parentNode.innerHTML='<span style=\'font-size:14px; color:#999\'>ID:${key}</span>'">
                        </div>`;
                } else if (unicodeEmojiRegex.test(key)) {
                    // å¦‚æœæ˜¯ emoji ç¬¦å·
                    displayHtml = `<div class="emoji-display">${key}</div>`;
                } else {
                    // å…¶ä»–æƒ…å†µç›´æ¥å±•ç¤º
                    displayHtml = `${key}`;
                }

                tr.innerHTML = `
                    <td><span class="rank-num">${index + 1}</span></td>
                    <td>${displayHtml}</td>
                    <td><strong>${count}</strong></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // æ ¸å¿ƒä¿®æ”¹ï¼šæ¥æ”¶ senderInfoMap å¹¶åœ¨è¡¨æ ¼ä¸­æ˜¾ç¤ºå¤´åƒå’Œæ›´å‡†ç¡®çš„åå­—/è´¦å·
        function renderSpeakers(senders, senderInfoMap) {
            const tbody = document.getElementById('speakerTable').querySelector('tbody');
            tbody.innerHTML = '';
            
            const sorted = senders.sort((a, b) => b.messageCount - a.messageCount).slice(0, 50);
            
            sorted.forEach((s, index) => {
                const tr = document.createElement('tr');
                const barWidth = Math.max(1, s.percentage);
                const name = s.name;
                
                // 1. ä»æ˜ å°„è¡¨ä¸­è·å–æœ€æ–°ä¿¡æ¯
                const info = senderInfoMap.get(name) || { name: s.name, uin: 0, uid: '' };
                const displayName = info.name && info.name !== 'unknown' ? info.name : uin; 
                const displayUin = info.uin; 
                const uin = info.uin;

                // 2. æ„é€ å¤´åƒ URL (s=100æ˜¯å›¾ç‰‡å¤§å°å‚æ•°ï¼Œæ‚¨å¯ä»¥è°ƒæ•´)
                const avatarUrl = uin ? `https://q.qlogo.cn/g?b=qq&nk=${uin}&s=100` : ''; 
                
                const avatarHtml = uin ? 
                    `<img src="${avatarUrl}" style="width:32px; height:32px; border-radius:50%; margin-right:10px; object-fit: cover;" onerror="this.style.display='none';">` :
                    ''; // å¦‚æœæ²¡æœ‰ uinï¼Œåˆ™ä¸æ˜¾ç¤ºå¤´åƒ

                tr.innerHTML = `
                    <td><span class="rank-num">${index + 1}</span></td>
                    <td>
                        <div style="display:flex; align-items:center;">
                            ${avatarHtml}
                            <div>
                                <div style="font-weight:600">${displayName}</div>
                                <div style="font-size:12px; color:#999">${displayUin || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td>${s.messageCount}</td>
                    <td width="30%">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="flex:1; background:#e2e8f0; height:6px; border-radius:3px; overflow:hidden;">
                                <div style="width:${barWidth}%; background:var(--primary); height:100%;"></div>
                            </div>
                            <span style="font-size:12px; color:var(--text-sub)">${s.percentage.toFixed(1)}%</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // === æ ¸å¿ƒä¿®æ”¹ï¼šæ¥æ”¶ wordCounts å’Œ containerId ===
        function renderHotWords(wordCounts, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const sorted = Object.entries(wordCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 60); // å–å‰60ä¸ªè¯
            
            if (sorted.length === 0) {
                container.textContent = 'æš‚æ— ç¬¦åˆç­›é€‰æ¡ä»¶çš„çƒ­è¯ã€‚';
                container.style.justifyContent = 'flex-start';
                container.style.padding = '10px';
                return;
            }
            container.style.justifyContent = 'center';

            const maxVal = sorted[0][1];

            sorted.forEach(([word, count]) => {
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.textContent = word;
                tag.title = `${count} æ¬¡`;
                
                // ç®€å•çš„å­—ä½“å¤§å°æ˜ å°„
                const size = 0.8 + (count / maxVal) * 1.5; 
                tag.style.fontSize = `${Math.min(size, 2.5)}rem`;
                
                // éšæœºé€æ˜åº¦ï¼Œè®©é«˜é¢‘è¯æ›´æ·±è‰²
                const opacity = 0.5 + (count / maxVal) * 0.5;
                tag.style.opacity = opacity;

                container.appendChild(tag);
            });
        }
    </script>
</body>
</html>